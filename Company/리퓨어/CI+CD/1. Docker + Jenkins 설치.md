`==` CI 툴.

>	- 하나의 프로그램을 개발할 때 공유 영역인 Git등의 저장소에 저장된 프로젝트를 버전 출동을 방지하며 지속적 통합이 가능하도록 해줌.
>	
>	- 왜 Jenkins 사용?
>		- 개발자의 편의를 위한 많은 플러그인 제공
>			- Git 연동, 다른 EC2와의 통신을 위한 SSH 관리 등 제공
>		- 웹 인터페이스를 제공하여 사용이 편리함
>			- CLI가 아닌 GUI화면에서 편하게 이용가능
>		- Java 기반이라 JDK, Gradle, Maven의 설정을 편리하게 할 수 있음.
>![[Pasted image 20241216112319.png]]
>.
>- 바로 Jenkins를 설치하지 않고, Docker를 사용하면  Jenkins컨테이너만을 받아와 사용하면 됨.
>- so, 위(사진) 과정이 생략되고, 단순히 젠킨스 컨테이너만을 받아와 실행만 하면 됨.


- ### Jenkins 설치
#### 1. swap 메모리 설정
>	- jenkins 실행 중 메모리 부족으로 멈출 수 있기 때문에, 스왑 메모리를 설정해야함
>	
>	1. 메모리 상태 확인
```
ubuntu@ip-172-31-13-181:~$ free -h
               total        used        free      shared  buff/cache   available
Mem:           957Mi       515Mi       109Mi       1.0Mi       332Mi       287Mi
Swap:             0B          0B          0B
```
>	2. swap 메모리 설정
```
//swap 파일을 생성해준다.
# 메모리 상태 확인 시 swap이 있었지만 디렉토리 파일은 만들어줘야한다.
$ sudo mkdir /var/spool/swap
$ sudo touch /var/spool/swap/swapfile

#1GB의 Swap 파일을 생성
$ sudo fallocate -l 1G /var/spool/swap/swapfile


// swap 파일 설정.
#Swap 파일 권한 설정
$ sudo chmod 600 /var/spool/swap/swapfile

#Swap 파일을 스왑 영역으로 초기화
$ sudo mkswap /var/spool/swap/swapfile

#Swap 파일을 활성화
$ sudo swapon /var/spool/swap/swapfile

#시스템 재부팅 시에도 Swap이 유지되도록 설정
$ echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

or

$ sudo vim /etc/fstab
/var/spool/swap/swapfile none swap defaults 0 0

# 파일이 열리면 해당 파일 아래쪽에 하단 내용 입력 후 저장
# 입력 할 수 있도록 하는 명령어 -> if
# 파일 수정 후 저장하는 명령어-> esc키 누른 후 :wq 입력 후 엔터 
 or Ctrl+O → Enter → Ctrl+X)


// 메모리 상태 확인
# 현재 Swap 상태 확인
$ free -h
# Swap 목록 확인
$ sudo swapon --show
```

```
ubuntu@ip-172-31-7-200:~$ free -h
               total        used        free      shared  buff/cache   available
Mem:           957Mi       383Mi       131Mi       1.8Mi       616Mi       573Mi
Swap:          1.0Gi          0B       1.0Gi

```

#### 2. Docker 설치
```
#패키지 목록을 최신으로 업데이트
$ sudo apt-get update

#HTTPS 기반 저장소를 사용할 수 있도록 필수 패키지를 설치
$ sudo apt-get install \ 
	ca-certificates \ 
	curl \ 
	gnupg \ 
	lsb-release
```

2) Docker의 GPG키 추가
>	- Docker 공식 저장소에서 제공하는 패키지를 설치하려면 GPG 키를 추가해야 합니다. 
>	- GPG 키를 통해 패키지의 무결성과 출처를 검증할 수 있습니다.

```
# 키링 디렉토리 생성
$ sudo mkdir -p /etc/apt/keyrings

# Docker의 GPG 키 다운로드 및 추가
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
```

3) Docker 공식 저장소 추가
```
# Docker 패키지를 Ubuntu APT 소스 목록에 추가
$ echo \
"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu jammy stable" \
| sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

(현재 `noble` 대신 Docker가 공식적으로 지원하는 이전 Ubuntu 버전(jammy)의 코드명을 사용하여 설정.)
+ `jammy`는 Ubuntu 22.04 LTS 코드명


or

$ echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null




```
4) Docker 설치
```
# 패키지 목록을 업데이트
$ sudo apt-get update

# Docker를 설치
$ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 정상적으로 Docker가 설치되었는지 확인
$ sudo docker --version
$ sudo docker run hello-world
	출력 예시
	Hello from Docker!
	This message shows that your installation appears to be working correctly.


```

#### 3. Jenkins 컨테이너 설치
1) Jenkins는 **8080 포트**를 사용하므로, 호스트 시스템의 8080 포트를 컨테이너와 연결
```
# Jenkins 설치
$ sudo docker run -d --name jenkins -p 8080:8080 jenkins/jenkins:jdk11

# 확인
$ sudo docker ps
```


### 4. Jenkins 설정
1) nginx - default 파일 설정
>	- Jenkins를 실행하고 접근하기 위해서는 8080포트를 열어놔야함.
>	- `/etc/nginx/sites-available/default` 파일 **80번 포트 서버 단락**에 location {} 블록을  추가
>	- 이렇게 하면 Nginx가 **리버스 프록시** 역할을 수행하며 **Jenkins**의 8080 포트로 요청을 전달할 수 있음.
>	- 밑에 서버 설정 default파일 있음.
```
# nginx 파일 재설정
$ sudo nano /etc/nginx/sites-avilable/default

# nginx 설정파일에 오류 테스트
$ sudo nginx -t

# nginx 재시작
$ sudo systemctl restart nginx
```

2) AWS(서버)에 8080포트가 열려잇는지 확인.
![[Pasted image 20241217170406.png]]

3) 관리자 패스워드 등록
>	- 초기 접속을 위해 관리자 패스워드를 등록해야함.
>	- 해당 키를 확인하기 위해 Jenkins가 설치된 EC2에 접속해 아래의 명령어를 입력
```
# jenkins 컨테이너에 접속
$ sudo docker exec -it jenkins bash

# 초기 관리자 키 확인
$ cat /var/jenkins_home/secrets/initialAdminPassword
```


4) Jenkins 설치
![[Pasted image 20241217171809.png]]

![[Pasted image 20241217171836.png]]

![[Pasted image 20241218141227.png]]
![[Pasted image 20241218141257.png]]

![[Pasted image 20241218141425.png]]
젠킨스가 웹 인터페이스를 제공하는 덕분에 우리는 CLI가 아닌 GUI화면을 통해 CI/CD 를 구축할 수 있다.



#### + /etc/nginx/sites-available/default 파일 수정
```
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        server_name repurehc.com www.repurehc.com 52.79.111.122;

        # Redirect HTTP to HTTPS
        return 301 https://repurehc.com$request_uri;

        # Jenkins 리버스 프록시 설정
        location /jenkins/ {
                proxy_pass http://localhost:8080/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
        }
}

- location /jenkins/:
    - /jenkins/로 시작하는 요청을 Nginx가 Jenkins의 8080 포트로 전달합니다.
    - 예: `http://repurehc.com/jenkins` → http://localhost:8080/
    
- proxy_pass: 
    - Jenkins 서버의 주소를 지정합니다.  
    http://localhost:8080/은 Jenkins 컨테이너가 동일 서버의 8080 포트에서 실행될 때 사용
    
- proxy_set_header:
    - 요청 헤더를 설정해 Jenkins가 클라이언트 정보를 정확히 인식하도록 도와줍니다.
```



--------------------------------------------------------------------------

#### + /etc/fstab
>	- `/etc/fstab`은 시스템 부팅 시 파일 시스템 및 Swap 파티션/파일을 자동으로 마운트하는 설정 파일.
>	- 이 파일에 설정된 정보는 부팅 시 자동으로 적용됩니다.
>	
>	- 왜 여기에 swap 파일 등록하지?
>		- 1. 영구적 유지
>			- `sudo swapon /var/spool/swap/swapfile` 명령으로 Swap을 활성화하면 현재 세션에서는 작동하지만, 시스템을 재부팅하면 Swap 설정이 사라짐.
>			- /etc/fstab 에 등록하면 시스템이 부팅될 때 자동으로 swap을 활성화함.
>		- 2. 자동 관리
>			- 수동으로 SWAPON 명령어를 매번 입력하지 않아도 됨.
>		
>	- 등록 방식
>		- `$ /var/spool/swap/swapfile none swap defaults 0 0`

| 필드                         | 설명                       |
| -------------------------- | ------------------------ |
| `/var/spool/swap/swapfile` | Swap 파일의 경로              |
| `none`                     | 마운트 포인트가 필요 없음을 의미.      |
| `swap`                     | 이 항목이 Swap 영역임을 지정.      |
| `defaults`                 | 기본 옵션(읽기, 쓰기 등)을 사용.     |
| `0`                        | 덤프 백업 설정 (Swap에는 필요 없음). |
| `0`                        | 파일 시스템 체크(스킵하도록 설정).     |


```
+
echo '/var/spool/swap/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

1. echo '/var/spool/swap/swapfile none swap sw 0 0'
     : 이 명령어는 문자열 `'/var/spool/swap/swapfile none swap sw 0 0'`를 출력합니다.
2. | (파이프) : 출력된 문자열을 다음 명령어 (`tee`)로 전달합니다.
3. sudo tee -a /etc/fstab 
    - `tee` 명령은 입력받은 문자열을 **지정된 파일에 추가**합니다.
    - `-a` 옵션은 **append**(추가)를 의미합니다.
    - 즉, `/etc/fstab` 파일의 **맨 아래에 새로운 Swap 설정을 추가**합니다.
```



--------------------------------------------------------------------------

#### + http://IP:8080/ 에 안들어가지는 문제`
1.  Jenkins 컨테이너 상태 확인
   ` $ sudo docker ps`

2. Jenkins 로그 확인
   `$ sudo docker logs jenkins`

3. AWS 보안 그룹 확인
```
1. AWS 콘솔 → EC2 대시보드 → 인스턴스 선택 → 보안 그룹 확인.
2. 인바운드 규칙에서 다음 설정을 추가:
    - Type: Custom TCP Rule
    - Port Range: `8080`
    - Source**: 0.0.0.0/0 (모두 허용) 또는 특정 IP만 허용
```


--------------------------------------------------------------------------

#### ..
`+ 실제로 HTTPS 기반 저장소**를 사용할 수 있도록 필수 패키지를 설치`
![[Pasted image 20241217151114.png]]

`+ 실제 docker 저장소를 noble 대신 이전버전 jammy 코드로 설정`
![[Pasted image 20241217153820.png]]

`+ Docker 설치`
![[Pasted image 20241217155135.png]]

`+ Jenkins 설치`
![[Pasted image 20241217163630.png]]









#### 참조
 https://seongwon.dev/DevOps/20220715-CICD%EA%B5%AC%EC%B6%95%EA%B8%B01/
